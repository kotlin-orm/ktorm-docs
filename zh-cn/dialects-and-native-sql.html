<!-- build time:Sun Jun 05 2022 21:58:10 GMT+0800 (CST) --><!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>Ktorm | 方言与原生 SQL</title><meta name="keywords" content="Kotlin, ORM, SQL, DSL, sequence"><meta name="description" content=""><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="referrer" content="always"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,600,700" rel="stylesheet"><link href="/vendors/font-awesome/font-awesome-4.7.0.min.css" rel="stylesheet"><link href="/vendors/docsearch/docsearch-2.6.3.min.css" rel="stylesheet"><link href="/style/doc.css" rel="stylesheet"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"></head><body><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-180275463-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script type="text/javascript">window.__INITIAL_STATE__={page:{title:"方言与原生 SQL",lang:"zh-cn",related_path:"en/dialects-and-native-sql.html",path:"zh-cn/dialects-and-native-sql.html"},data:{"navigation-zh-cn":{home:[{title:"快速开始",link:"zh-cn/quick-start.html",color:"purple",icon:"flash",description:"快速配置 Ktorm 并开始使用"},{title:"SQL DSL",link:"zh-cn/query.html",color:"blue",icon:"code",description:'<a href="/zh-cn/schema-definition.html">定义表结构</a>，使用强类型的灵活的<a href="/zh-cn/query.html">查询 DSL</a>'},{title:"实体序列",link:"zh-cn/entity-sequence.html",color:"green",icon:"line-chart",description:'<a href="/zh-cn/entities-and-column-binding.html">配置列绑定</a>，使用<a href="/zh-cn/entity-sequence.html">序列 API</a> 获取实体对象'},{title:"API 文档",link:"api-docs/index.html",color:"red",icon:"paperclip",description:"查看 Ktorm 中类与函数的 API 文档"}],main:[{text:"概述",type:"link",path:"zh-cn/",isCurrent:!1},{text:"快速开始",type:"link",path:"zh-cn/quick-start.html",isCurrent:!1},{text:"连接管理",type:"label",isCurrent:!1},{text:"连接数据库",type:"link",path:"zh-cn/connect-to-databases.html",isCurrent:!1},{text:"事务管理",type:"link",path:"zh-cn/transaction-management.html",isCurrent:!1},{text:"Spring 支持",type:"link",path:"zh-cn/spring-support.html",isCurrent:!1},{text:"SQL DSL",type:"label",isCurrent:!1},{text:"定义表结构",type:"link",path:"zh-cn/schema-definition.html",isCurrent:!1},{text:"查询",type:"link",path:"zh-cn/query.html",isCurrent:!1},{text:"联表",type:"link",path:"zh-cn/joining.html",isCurrent:!1},{text:"增删改",type:"link",path:"zh-cn/dml.html",isCurrent:!1},{text:"运算符",type:"link",path:"zh-cn/operators.html",isCurrent:!1},{text:"方言与原生 SQL",type:"link",path:"zh-cn/dialects-and-native-sql.html",isCurrent:!1},{text:"实体类 API",type:"label",isCurrent:!1},{text:"实体类与列绑定",type:"link",path:"zh-cn/entities-and-column-binding.html",isCurrent:!1},{text:"实体查询",type:"link",path:"zh-cn/entity-finding.html",isCurrent:!1},{text:"实体序列",type:"link",path:"zh-cn/entity-sequence.html",isCurrent:!1},{text:"序列聚合",type:"link",path:"zh-cn/sequence-aggregation.html",isCurrent:!1},{text:"实体增删改",type:"link",path:"zh-cn/entity-dml.html",isCurrent:!0},{text:"使用任意的类作为实体类",type:"link",path:"zh-cn/define-entities-as-any-kind-of-classes.html",isCurrent:!1},{text:"支持和反馈",type:"label",isCurrent:!1},{text:"API 文档",type:"support-link",path:"api-docs/index.html",isCurrent:!1},{text:"问题反馈",type:"support-link",path:"https://github.com/kotlin-orm/ktorm/issues/new",isCurrent:!1},{text:"打赏作者",type:"support-link",path:"zh-cn/sponsor.html",isCurrent:!1}]},"navigation-en":{home:[{title:"Quick Start",link:"en/quick-start.html",color:"purple",icon:"flash",description:"Setting up Ktorm and starting up."},{title:"SQL DSL",link:"en/query.html",color:"blue",icon:"code",description:'Use the strong-typed and flexible <a href="/en/query.html">query DSL</a> after <a href="/en/schema-definition.html">defining table schemas</a>.'},{title:"Entity Sequence",link:"en/entity-sequence.html",color:"green",icon:"line-chart",description:'Obtain entities via <a href="/en/entity-sequence.html">sequence APIs</a> after <a href="/en/entities-and-column-binding.html">column bindings</a> configured.'},{title:"API Documents",link:"api-docs/index.html",color:"red",icon:"paperclip",description:"API documents for Ktorm's classes and functions."}],main:[{text:"Overview",type:"link",path:"",isCurrent:!1},{text:"Quick Start",type:"link",path:"en/quick-start.html",isCurrent:!1},{text:"CONNECTION MANAGEMENT",type:"label",isCurrent:!1},{text:"Connect to Databases",type:"link",path:"en/connect-to-databases.html",isCurrent:!1},{text:"Transaction Management",type:"link",path:"en/transaction-management.html",isCurrent:!1},{text:"Spring Support",type:"link",path:"en/spring-support.html",isCurrent:!0},{text:"SQL DSL",type:"label",isCurrent:!1},{text:"Schema Definition",type:"link",path:"en/schema-definition.html",isCurrent:!1},{text:"Query",type:"link",path:"en/query.html",isCurrent:!1},{text:"Joining",type:"link",path:"en/joining.html",isCurrent:!1},{text:"Data Manipulation",type:"link",path:"en/dml.html",isCurrent:!1},{text:"Operators",type:"link",path:"en/operators.html",isCurrent:!1},{text:"Dialects & Native SQL",type:"link",path:"en/dialects-and-native-sql.html",isCurrent:!1},{text:"ENTITY API",type:"label",isCurrent:!1},{text:"Entities & Column Binding",type:"link",path:"en/entities-and-column-binding.html",isCurrent:!1},{text:"Entity Query",type:"link",path:"en/entity-finding.html",isCurrent:!1},{text:"Entity Sequence",type:"link",path:"en/entity-sequence.html",isCurrent:!1},{text:"Sequence Aggregation",type:"link",path:"en/sequence-aggregation.html",isCurrent:!1},{text:"Entity Manipulation",type:"link",path:"en/entity-dml.html",isCurrent:!1},{text:"Define Entities as Any Class",type:"link",path:"en/define-entities-as-any-kind-of-classes.html",isCurrent:!1},{text:"SUPPORT & FEEDBACK",type:"label",isCurrent:!1},{text:"API Documents",type:"support-link",path:"api-docs/index.html",isCurrent:!1},{text:"Issue Feedback",type:"support-link",path:"https://github.com/kotlin-orm/ktorm/issues/new",isCurrent:!1},{text:"Sponsor the Project",type:"support-link",path:"en/sponsor.html",isCurrent:!1}]}},config:{timezone:null,root:"/",time_format:"HH:mm:ss",theme:"doc",algolia:{appId:"2W81KMSLOD",apiKey:"2a146a809de068d9b7a07ba3fb70b4e5",indexName:"ktorm",chunkSize:5e3,fields:["title","lang","date","updated","_content:truncate,0,5200","path","permalink"]}}},window.localStorage&&"true"===window.localStorage.getItem("navigation_collapsed")&&document.getElementsByTagName("body")[0].classList.add("doc-navigation--is-collapsed")</script><div id="navigation-container"><div class="doc-navigation" data-reactroot=""><nav class="doc-navbar"><span class="doc-navbar__logo"><a href="/zh-cn/"><img src="/images/logo.png" class="doc-navbar__logo__img"><img src="/images/logo-middle.png" class="doc-navbar__logo__img-full"></a></span><i class="dc-icon dc-icon--close dc-icon--interactive doc-sidebar-close doc-navbar__sidebar-close doc-navbar__sidebar-close--desktop"></i><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-navbar__sidebar-toggle"></i><span class="lang-switcher"><span><img src="/images/cn.png"><span>简体中文</span></span><span class="lang-divider"> | </span><span><img src="/images/us.png"><a href="/en/dialects-and-native-sql.html">English</a></span></span></nav><nav class="doc-sidebar"><div class="doc-sidebar__vertical-menu"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-sidebar-toggle--primary doc-sidebar__vertical-menu__item"></i><i class="dc-icon dc-icon--search dc-icon--interactive doc-sidebar__vertical-menu__item doc-sidebar__vertical-menu__item--primary"></i></div><div class="doc-sidebar-content"><div class="doc-sidebar__search-form"><div class="dc-search-form doc-search-form"><input type="search" id="doc-search-input" class="dc-input dc-search-form__input doc-search-form__input" placeholder="搜索文档" autofocus><button class="dc-btn dc-search-form__btn doc-search-form__btn" aria-label="Search"><i class="dc-icon dc-icon--search"></i></button></div></div><ul class="doc-sidebar-list"><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/" target="_self"><span>概述</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/quick-start.html" target="_self"><span>快速开始</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--label"><span>连接管理</span></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/connect-to-databases.html" target="_self"><span>连接数据库</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/transaction-management.html" target="_self"><span>事务管理</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/spring-support.html" target="_self"><span>Spring 支持</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--label"><span>SQL DSL</span></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/schema-definition.html" target="_self"><span>定义表结构</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/query.html" target="_self"><span>查询</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/joining.html" target="_self"><span>联表</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/dml.html" target="_self"><span>增删改</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/operators.html" target="_self"><span>运算符</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link doc-sidebar-list__item--current"><a href="/zh-cn/dialects-and-native-sql.html" target="_self"><span>方言与原生 SQL</span></a><ul class="doc-sidebar-list__toc-list"></ul></li><li class="doc-sidebar-list__item doc-sidebar-list__item--label"><span>实体类 API</span></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/entities-and-column-binding.html" target="_self"><span>实体类与列绑定</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/entity-finding.html" target="_self"><span>实体查询</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/entity-sequence.html" target="_self"><span>实体序列</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/sequence-aggregation.html" target="_self"><span>序列聚合</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/entity-dml.html" target="_self"><span>实体增删改</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/define-entities-as-any-kind-of-classes.html" target="_self"><span>使用任意的类作为实体类</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--label"><span>支持和反馈</span></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/api-docs/index.html" target="_self"><span>API 文档</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="https://github.com/kotlin-orm/ktorm/issues/new" target="_self"><span>问题反馈</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/sponsor.html" target="_self"><span>打赏作者</span></a></li></ul></div></nav></div></div><div class="doc-content"><div id="lang-switcher-container" class="lang-switcher-container"><span class="lang-switcher" data-reactroot=""><span><img src="/images/cn.png"><span>简体中文</span></span><span class="lang-divider"> | </span><span><img src="/images/us.png"><a href="/en/dialects-and-native-sql.html">English</a></span></span></div><div class="dc-page"><div class="dc-card"><div id="doc-search-results" class="doc-search-results"><div id="doc-search-stats"></div><div id="doc-search-hits"></div><div id="doc-search-pagination"></div></div><article id="page-content" class="doc-formatting"><a class="page-link-to-github" target="_blank" href="https://github.com/kotlin-orm/ktorm-docs/edit/master/source/zh-cn/dialects-and-native-sql.md"><i class="icon fa fa-github"></i> <span class="text">编辑本页</span></a><h1 id="方言与原生-SQL"><a href="#方言与原生-SQL" class="headerlink" title="方言与原生 SQL"></a>方言与原生 SQL</h1><p>我们知道，SQL 语言虽然存在统一的标准，但是在标准之外，各种数据库都有着自己独特的特性。Ktorm 的核心模块（ktorm-core）仅对标准 SQL 提供了支持，如果希望使用某个数据库中特有的功能，我们就会用到方言模块。</p><h2 id="启用方言"><a href="#启用方言" class="headerlink" title="启用方言"></a>启用方言</h2><p>在 Ktorm 中，方言被抽象为一个接口 <code>SqlDialect</code>。Ktorm 目前支持多种数据库方言，每种方言都作为一个独立于 ktorm-core 的模块发布，他们都会提供一个自己的 <code>SqlDialect</code> 实现类：</p><table><thead><tr><th>数据库类型</th><th>模块名</th><th>SqlDialect 实现类</th></tr></thead><tbody><tr><td>MySQL</td><td>ktorm-support-mysql</td><td>org.ktorm.support.mysql.MySqlDialect</td></tr><tr><td>PostgreSQL</td><td>ktorm-support-postgresql</td><td>org.ktorm.support.postgresql.PostgreSqlDialect</td></tr><tr><td>Oracle</td><td>ktorm-support-oracle</td><td>org.ktorm.support.oracle.OracleDialect</td></tr><tr><td>SqlServer</td><td>ktorm-support-sqlserver</td><td>org.ktorm.support.sqlserver.SqlServerDialect</td></tr><tr><td>SQLite</td><td>ktorm-support-sqlite</td><td>org.ktorm.support.sqlite.SQLiteDialect</td></tr></tbody></table><p>现在我们以 MySQL 的 <code>on duplicate key update</code> 功能为例，介绍如何在 Ktorm 中启用方言。</p><p>MySQL 的 <code>on duplicate key update</code> 功能可以在插入记录时，判断是否存在键冲突，如果有冲突则自动执行更新操作，这是标准 SQL 中不支持的用法。要使用这个功能，我们首先需要在项目中添加 ktorm-support-mysql 模块的依赖，如果你使用 Maven：</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.ktorm<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ktorm-support-mysql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;ktorm.version&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>或者 gradle：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">"org.ktorm:ktorm-support-mysql:$&#123;ktorm.version&#125;"</span></span><br></pre></td></tr></table></figure><p>添加完依赖后，我们需要修改 <code>Database.connect</code> 函数的调用处，这个函数用于创建一个 <code>Database</code> 对象，Ktorm 正是用这个对象来连接到数据库。我们需要指定 <code>dialect</code> 参数，告诉 Ktorm 需要使用哪个 <code>SqlDialect</code> 的实现类：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> database = Database.connect(</span><br><span class="line">    url = <span class="string">"jdbc:mysql://localhost:3306/ktorm"</span>, </span><br><span class="line">    driver = <span class="string">"com.mysql.jdbc.Driver"</span>, </span><br><span class="line">    user = <span class="string">"root"</span>, </span><br><span class="line">    password = <span class="string">"***"</span>, </span><br><span class="line">    dialect = MySqlDialect()</span><br><span class="line">)</span><br></pre></td></tr></table></figure><blockquote><p>从 2.4 版本开始，Ktorm 的各个方言模块遵从了 JDK <code>ServiceLoader</code> SPI 的约定，因此在创建 <code>Database</code> 实例时，我们不必再显式指定 <code>dialect</code> 参数。Ktorm 会自动从 classpath 中检测出我们使用的方言，只需要保证依赖中包含具体的方言模块即可。</p></blockquote><p>现在，我们就已经启用了 MySQL 的方言，可以使用它的功能了。尝试调用一下 <code>insertOrUpdate</code> 函数：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">database.insertOrUpdate(Employees) &#123;</span><br><span class="line">    <span class="keyword">set</span>(it.id, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">set</span>(it.name, <span class="string">"vince"</span>)</span><br><span class="line">    <span class="keyword">set</span>(it.job, <span class="string">"engineer"</span>)</span><br><span class="line">    <span class="keyword">set</span>(it.salary, <span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">set</span>(it.hireDate, LocalDate.now())</span><br><span class="line">    <span class="keyword">set</span>(it.departmentId, <span class="number">1</span>)</span><br><span class="line">    onDuplicateKey &#123;</span><br><span class="line">        <span class="keyword">set</span>(it.salary, it.salary + <span class="number">900</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>生成 SQL：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_employee (<span class="keyword">id</span>, <span class="keyword">name</span>, job, salary, hire_date, department_id) <span class="keyword">values</span> (?, ?, ?, ?, ?, ?) </span><br><span class="line"><span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span> salary = salary + ?</span><br></pre></td></tr></table></figure><p>完美！</p><h2 id="方言功能列表"><a href="#方言功能列表" class="headerlink" title="方言功能列表"></a>方言功能列表</h2><p>那么，除了前面出现过的那些，Ktorm 内置的方言还提供了什么功能呢？</p><p><strong>ktorm-support-mysql</strong>：</p><ul><li>支持 Ktorm 的标准分页函数，自动翻译为 MySQL 的 <code>limit ?, ?</code> 语句</li><li>支持 insert 语句的扩展语法，如 <a href="https://www.ktorm.org/api-docs/org.ktorm.support.mysql/insert-or-update.html">insertOrUpdate</a>、<a href="https://www.ktorm.org/api-docs/org.ktorm.support.mysql/bulk-insert.html">bulkInsert</a>、<a href="https://www.ktorm.org/api-docs/org.ktorm.support.mysql/bulk-insert-or-update.html">bulkInsertOrUpdate</a> 等函数</li><li>通过 <a href="https://www.ktorm.org/api-docs/org.ktorm.support.mysql/locking.html">locking</a> 函数支持 <code>select ... for update</code> 等加锁语法</li><li>支持基于 <a href="https://www.ktorm.org/api-docs/org.ktorm.support.mysql/match.html">match</a> 和 <a href="https://www.ktorm.org/api-docs/org.ktorm.support.mysql/against.html">against</a> 的全文搜索</li><li>支持常用的 json 操作函数，如 <a href="https://www.ktorm.org/api-docs/org.ktorm.support.mysql/json-contains.html">jsonContains</a>、<a href="https://www.ktorm.org/api-docs/org.ktorm.support.mysql/json-extract.html">jsonExtract</a></li><li>支持 <a href="https://www.ktorm.org/api-docs/org.ktorm.support.mysql/-i-f.html">IF</a>、<a href="https://www.ktorm.org/api-docs/org.ktorm.support.mysql/if-null.html">ifNull</a>、<a href="https://www.ktorm.org/api-docs/org.ktorm.support.mysql/greatest.html">greatest</a>、<a href="https://www.ktorm.org/api-docs/org.ktorm.support.mysql/least.html">least</a>、<a href="https://www.ktorm.org/api-docs/org.ktorm.support.mysql/replace.html">replace</a> 等常用函数</li><li>更多功能请参考详细的 API 文档 <a href="https://www.ktorm.org/api-docs/org.ktorm.support.mysql/index.html">https://www.ktorm.org/api-docs/org.ktorm.support.mysql/index.html</a></li></ul><p><strong>ktorm-support-postgresql</strong>：</p><ul><li>支持 Ktorm 的标准分页函数，自动翻译为 PostgreSQL 中的 <code>limit ? offset ?</code> 语句</li><li>支持 insert 语句的扩展语法，如 <a href="https://www.ktorm.org/api-docs/org.ktorm.support.postgresql/insert-returning.html">insertReturning</a>、<a href="https://www.ktorm.org/api-docs/org.ktorm.support.postgresql/insert-or-update.html">insertOrUpdate</a>、<a href="https://www.ktorm.org/api-docs/org.ktorm.support.postgresql/bulk-insert.html">bulkInsert</a>、<a href="https://www.ktorm.org/api-docs/org.ktorm.support.postgresql/bulk-insert-or-update.html">bulkInsertOrUpdate</a> 等函数</li><li>通过 <a href="https://www.ktorm.org/api-docs/org.ktorm.support.postgresql/locking.html">locking</a> 函数支持 <code>select ... for update</code> 等加锁语法</li><li>支持 <a href="https://www.ktorm.org/api-docs/org.ktorm.support.postgresql/hstore.html">hstore</a> 数据类型及其操作符</li><li>更多功能请参考详细的 API 文档 <a href="https://www.ktorm.org/api-docs/org.ktorm.support.postgresql/index.html">https://www.ktorm.org/api-docs/org.ktorm.support.postgresql/index.html</a></li></ul><p><strong>ktorm-support-oracle</strong>：</p><ul><li>支持 Ktorm 的标准分页函数，自动翻译为 Oracle 中使用 <code>rownum</code> 筛选分页的写法</li><li>更多功能请参考详细的 API 文档：<a href="https://www.ktorm.org/api-docs/org.ktorm.support.oracle/index.html">https://www.ktorm.org/api-docs/org.ktorm.support.oracle/index.html</a></li></ul><p><strong>ktorm-support-sqlserver</strong>：</p><ul><li>支持 Ktorm 的标准分页函数，自动翻译为 SqlServer 中使用 <code>top</code> 和 <code>row_number() over(...)</code> 筛选分页的写法</li><li>支持 SqlServer 特有的 <a href="https://www.ktorm.org/api-docs/org.ktorm.support.sqlserver/datetimeoffset.html">datetimeoffset</a> 数据类型</li><li>更多功能请参考详细的 API 文档 <a href="https://www.ktorm.org/api-docs/org.ktorm.support.sqlserver/index.html">https://www.ktorm.org/api-docs/org.ktorm.support.sqlserver/index.html</a></li></ul><p><strong>ktorm-support-sqlite</strong>：</p><ul><li>支持 Ktorm 的标准分页函数，自动翻译为 SQLite 的 <code>limit ?, ?</code> 语句</li><li>更多功能请参考详细的 API 文档 <a href="https://www.ktorm.org/api-docs/org.ktorm.support.sqlite/index.html">https://www.ktorm.org/api-docs/org.ktorm.support.sqlite/index.html</a></li></ul><p>很遗憾地告诉大家，虽然 Ktorm 一直声称支持多种方言，但是实际上除了 MySQL 和 PostgreSQL 以外，我们对其他数据库的特殊语法的支持实在是十分有限。这是因为作者本人的精力有限，只能做到支持工作中常用的数据库，对于其他数据库纷繁复杂的特殊用法只能暂时把优先级降低。</p><p>好在核心库中支持的标准 SQL 已经能够实现我们的大部分需求，在那些方言支持完成之前，只使用标准 SQL 的功能子集也不会影响我们的业务功能。</p><p>Ktorm 的设计是开放的，为其增加功能十分容易，我们在前面的章节中就曾经示范过如何对 Ktorm 进行扩展。因此如果你需要的话，完全可以自己编写扩展，同时，欢迎 fork 我们的仓库，提交 PR，我们会将你编写的扩展合并到主分支，让更多的人受益。期待您的贡献！</p><h2 id="原生-SQL"><a href="#原生-SQL" class="headerlink" title="原生 SQL"></a>原生 SQL</h2><p>在极少数情况下，我们会遇到一些特殊的业务，Ktorm 可能暂时无法支持。比如 Ktorm 目前并不支持的复杂查询（如相关子查询），或者某些数据库中的特殊功能（如 SQL Server 中的 cross apply），再或者是对表结构进行操作的 DDL。</p><p>为了应对这种场景，Ktorm 提供了直接执行原生 SQL 的方式，这只需要我们写一点 JDBC 的代码。我们需要使用 <code>Database</code> 类中的 <code>useConnection</code> 函数获取数据库连接，获取到 <code>Connection</code> 实例之后，剩下的事情就和其他 JDBC 程序没有任何区别了。下面是一个例子：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> names = database.useConnection &#123; conn -&gt;</span><br><span class="line">    <span class="keyword">val</span> sql = <span class="string">"""</span></span><br><span class="line"><span class="string">        select name from t_employee</span></span><br><span class="line"><span class="string">        where department_id = ?</span></span><br><span class="line"><span class="string">        order by id</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    conn.prepareStatement(sql).use &#123; statement -&gt;</span><br><span class="line">        statement.setInt(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        statement.executeQuery().asIterable().map &#123; it.getString(<span class="number">1</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">names.forEach &#123; println(it) &#125;</span><br></pre></td></tr></table></figure><p>乍一看，上面的代码只是单纯的 JDBC 操作，但是它其实也受益于 Ktorm 提供的便利的支持：</p><ul><li><code>useConnection</code> 函数用于获取或创建连接。如果当前线程已开启事务，在闭包中传入开启了事务的当前连接；否则，新建一个连接，在使用完毕后将其关闭。这正是 Ktorm 内部执行生成的 SQL 时用于获取数据库连接的函数，使用这个函数，可以与 Ktorm 内部执行的 SQL 共享连接池或者事务。</li><li><code>asIterable</code> 函数用于将 <code>ResultSet</code> 对象包装成 <code>Iterable</code>，这样我们就能够使用 for-each 循环对其进行迭代，也可以使用 <code>map</code>、<code>flatMap</code> 等扩展函数对结果集进行二次处理。</li></ul><blockquote><p>注意：尽管 Ktorm 对原生 SQL 也提供了方便的支持，但我们并不推荐你使用它，因为这严重违背了 Ktorm 的设计哲学。当你使用原生 SQL 时，Ktorm 原本提供的强类型 DSL 的优势都荡然无存。因此，在你开始考虑使用原生 SQL 解决问题的时候，不妨先思考一下是否真的有必要，一般来说，大部分复杂的 SQL 查询都可以转换为等价的简单多表连接或自连接查询，大部分数据库中特殊关键字或函数也可以通过前面章节中介绍的方法编写扩展来实现。</p></blockquote><div id="support-footer-container"><div class="doc-support-footer" data-reactroot=""><div class="doc-footer-link">上一篇：<a href="/zh-cn/operators.html">运算符</a></div><div class="doc-footer-link">下一篇：<a href="/zh-cn/entities-and-column-binding.html">实体类与列绑定</a></div>对文档内容有疑问？请在侧边栏尝试搜索或者在 GitHub <a href="https://github.com/kotlin-orm/ktorm/issues/new" target="_blank" rel="noopener">提出 issue</a></div></div></article></div></div><div class="doc-footer">&copy; 2022 KTORM.ORG. Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="noopener">Apache 2.0</a><br>Hosted by <a href="https://github.com/kotlin-orm/ktorm" target="_blank" rel="noopener">GitHub</a> <a href="https://github.com/kotlin-orm/ktorm/stargazers" target="_blank" rel="noopener"><img src="https://img.shields.io/github/stars/kotlin-orm/ktorm.svg?style=social" alt="Stars"></a></div></div><script src="/vendors/jquery/jquery-3.2.1.min.js"></script><script src="/script/doc.js"></script><script type="text/javascript" src="/vendors/docsearch/docsearch-2.6.3.min.js"></script><script type="text/javascript">docsearch({appId:"0DGANM0MZ3",apiKey:"071ea85fb6b0933d3f3d3925aa434e23",indexName:"ktorm",inputSelector:"#doc-search-input",algoliaOptions:{facetFilters:["lang:zh-cn","tags:doc"]},autocompleteOptions:{hint:!1,appendTo:"body"},debug:!1})</script><script>!function(){$(".kotlin .code .keyword").each(function(){var e=$(this);("where"===e.text()||"set"===e.text())&&e.removeClass("keyword")})}()</script></body></html><!-- rebuild by neat -->