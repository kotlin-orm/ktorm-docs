<!-- build time:Sun Jun 05 2022 16:42:51 GMT+0800 (CST) --><!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>Ktorm | Ktorm 3.0 不兼容更新</title><meta name="keywords" content="Kotlin, ORM, SQL, DSL, sequence"><meta name="description" content=""><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="referrer" content="always"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,600,700" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css"><link href="/style/doc.css" rel="stylesheet"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"></head><body><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-180275463-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script type="text/javascript">window.__INITIAL_STATE__={page:{title:"Ktorm 3.0 不兼容更新",lang:"zh-cn",related_path:"en/break-changes-in-ktorm-3.0.html",path:"zh-cn/break-changes-in-ktorm-3.0.html"},data:{"navigation-en":{home:[{title:"Quick Start",link:"en/quick-start.html",color:"purple",icon:"flash",description:"Setting up Ktorm and starting up."},{title:"SQL DSL",link:"en/query.html",color:"blue",icon:"code",description:'Use the strong-typed and flexible <a href="/en/query.html">query DSL</a> after <a href="/en/schema-definition.html">defining table schemas</a>.'},{title:"Entity Sequence",link:"en/entity-sequence.html",color:"green",icon:"line-chart",description:'Obtain entities via <a href="/en/entity-sequence.html">sequence APIs</a> after <a href="/en/entities-and-column-binding.html">column bindings</a> configured.'},{title:"API Documents",link:"api-docs/index.html",color:"red",icon:"paperclip",description:"API documents for Ktorm's classes and functions."}],main:[{text:"Overview",type:"link",path:"",isCurrent:!1},{text:"Quick Start",type:"link",path:"en/quick-start.html",isCurrent:!1},{text:"CONNECTION MANAGEMENT",type:"label",isCurrent:!1},{text:"Connect to Databases",type:"link",path:"en/connect-to-databases.html",isCurrent:!1},{text:"Transaction Management",type:"link",path:"en/transaction-management.html",isCurrent:!1},{text:"Spring Support",type:"link",path:"en/spring-support.html",isCurrent:!1},{text:"SQL DSL",type:"label",isCurrent:!1},{text:"Schema Definition",type:"link",path:"en/schema-definition.html",isCurrent:!1},{text:"Query",type:"link",path:"en/query.html",isCurrent:!1},{text:"Joining",type:"link",path:"en/joining.html",isCurrent:!1},{text:"Data Manipulation",type:"link",path:"en/dml.html",isCurrent:!1},{text:"Operators",type:"link",path:"en/operators.html",isCurrent:!1},{text:"Dialects & Native SQL",type:"link",path:"en/dialects-and-native-sql.html",isCurrent:!1},{text:"ENTITY API",type:"label",isCurrent:!1},{text:"Entities & Column Binding",type:"link",path:"en/entities-and-column-binding.html",isCurrent:!1},{text:"Entity Query",type:"link",path:"en/entity-finding.html",isCurrent:!1},{text:"Entity Sequence",type:"link",path:"en/entity-sequence.html",isCurrent:!0},{text:"Sequence Aggregation",type:"link",path:"en/sequence-aggregation.html",isCurrent:!1},{text:"Entity Manipulation",type:"link",path:"en/entity-dml.html",isCurrent:!1},{text:"Define Entities as Any Class",type:"link",path:"en/define-entities-as-any-kind-of-classes.html",isCurrent:!1},{text:"SUPPORT & FEEDBACK",type:"label",isCurrent:!1},{text:"API Documents",type:"support-link",path:"api-docs/index.html",isCurrent:!1},{text:"Issue Feedback",type:"support-link",path:"https://github.com/kotlin-orm/ktorm/issues/new",isCurrent:!1},{text:"Sponsor the Project",type:"support-link",path:"en/sponsor.html",isCurrent:!1}]},"navigation-zh-cn":{home:[{title:"快速开始",link:"zh-cn/quick-start.html",color:"purple",icon:"flash",description:"快速配置 Ktorm 并开始使用"},{title:"SQL DSL",link:"zh-cn/query.html",color:"blue",icon:"code",description:'<a href="/zh-cn/schema-definition.html">定义表结构</a>，使用强类型的灵活的<a href="/zh-cn/query.html">查询 DSL</a>'},{title:"实体序列",link:"zh-cn/entity-sequence.html",color:"green",icon:"line-chart",description:'<a href="/zh-cn/entities-and-column-binding.html">配置列绑定</a>，使用<a href="/zh-cn/entity-sequence.html">序列 API</a> 获取实体对象'},{title:"API 文档",link:"api-docs/index.html",color:"red",icon:"paperclip",description:"查看 Ktorm 中类与函数的 API 文档"}],main:[{text:"概述",type:"link",path:"zh-cn/",isCurrent:!1},{text:"快速开始",type:"link",path:"zh-cn/quick-start.html",isCurrent:!1},{text:"连接管理",type:"label",isCurrent:!1},{text:"连接数据库",type:"link",path:"zh-cn/connect-to-databases.html",isCurrent:!1},{text:"事务管理",type:"link",path:"zh-cn/transaction-management.html",isCurrent:!1},{text:"Spring 支持",type:"link",path:"zh-cn/spring-support.html",isCurrent:!1},{text:"SQL DSL",type:"label",isCurrent:!1},{text:"定义表结构",type:"link",path:"zh-cn/schema-definition.html",isCurrent:!1},{text:"查询",type:"link",path:"zh-cn/query.html",isCurrent:!1},{text:"联表",type:"link",path:"zh-cn/joining.html",isCurrent:!1},{text:"增删改",type:"link",path:"zh-cn/dml.html",isCurrent:!1},{text:"运算符",type:"link",path:"zh-cn/operators.html",isCurrent:!1},{text:"方言与原生 SQL",type:"link",path:"zh-cn/dialects-and-native-sql.html",isCurrent:!1},{text:"实体类 API",type:"label",isCurrent:!1},{text:"实体类与列绑定",type:"link",path:"zh-cn/entities-and-column-binding.html",isCurrent:!1},{text:"实体查询",type:"link",path:"zh-cn/entity-finding.html",isCurrent:!1},{text:"实体序列",type:"link",path:"zh-cn/entity-sequence.html",isCurrent:!1},{text:"序列聚合",type:"link",path:"zh-cn/sequence-aggregation.html",isCurrent:!1},{text:"实体增删改",type:"link",path:"zh-cn/entity-dml.html",isCurrent:!1},{text:"使用任意的类作为实体类",type:"link",path:"zh-cn/define-entities-as-any-kind-of-classes.html",isCurrent:!1},{text:"支持和反馈",type:"label",isCurrent:!1},{text:"API 文档",type:"support-link",path:"api-docs/index.html",isCurrent:!1},{text:"问题反馈",type:"support-link",path:"https://github.com/kotlin-orm/ktorm/issues/new",isCurrent:!1},{text:"打赏作者",type:"support-link",path:"zh-cn/sponsor.html",isCurrent:!1}]}},config:{timezone:null,root:"/",time_format:"HH:mm:ss",theme:"doc",algolia:{appId:"2W81KMSLOD",apiKey:"2a146a809de068d9b7a07ba3fb70b4e5",indexName:"ktorm",chunkSize:5e3,fields:["title","lang","date","updated","_content:truncate,0,5200","path","permalink"]}}},window.localStorage&&"true"===window.localStorage.getItem("navigation_collapsed")&&document.getElementsByTagName("body")[0].classList.add("doc-navigation--is-collapsed")</script><div id="navigation-container"><div class="doc-navigation" data-reactroot=""><nav class="doc-navbar"><span class="doc-navbar__logo"><a href="/zh-cn/"><img src="/images/logo.png" class="doc-navbar__logo__img"><img src="/images/logo-middle.png" class="doc-navbar__logo__img-full"></a></span><i class="dc-icon dc-icon--close dc-icon--interactive doc-sidebar-close doc-navbar__sidebar-close doc-navbar__sidebar-close--desktop"></i><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-navbar__sidebar-toggle"></i><span class="lang-switcher"><span><img src="/images/cn.png"><span>简体中文</span></span><span class="lang-divider"> | </span><span><img src="/images/us.png"><a href="/en/break-changes-in-ktorm-3.0.html">English</a></span></span></nav><nav class="doc-sidebar"><div class="doc-sidebar__vertical-menu"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-sidebar-toggle--primary doc-sidebar__vertical-menu__item"></i><i class="dc-icon dc-icon--search dc-icon--interactive doc-sidebar__vertical-menu__item doc-sidebar__vertical-menu__item--primary"></i></div><div class="doc-sidebar-content"><div class="doc-sidebar__search-form"><div class="dc-search-form doc-search-form"><input type="search" id="doc-search-input" class="dc-input dc-search-form__input doc-search-form__input" placeholder="搜索文档" autofocus><button class="dc-btn dc-search-form__btn doc-search-form__btn" aria-label="Search"><i class="dc-icon dc-icon--search"></i></button></div></div><ul class="doc-sidebar-list"><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/" target="_self"><span>概述</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/quick-start.html" target="_self"><span>快速开始</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--label"><span>连接管理</span></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/connect-to-databases.html" target="_self"><span>连接数据库</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/transaction-management.html" target="_self"><span>事务管理</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/spring-support.html" target="_self"><span>Spring 支持</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--label"><span>SQL DSL</span></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/schema-definition.html" target="_self"><span>定义表结构</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/query.html" target="_self"><span>查询</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/joining.html" target="_self"><span>联表</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/dml.html" target="_self"><span>增删改</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/operators.html" target="_self"><span>运算符</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/dialects-and-native-sql.html" target="_self"><span>方言与原生 SQL</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--label"><span>实体类 API</span></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/entities-and-column-binding.html" target="_self"><span>实体类与列绑定</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/entity-finding.html" target="_self"><span>实体查询</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/entity-sequence.html" target="_self"><span>实体序列</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/sequence-aggregation.html" target="_self"><span>序列聚合</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/entity-dml.html" target="_self"><span>实体增删改</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/define-entities-as-any-kind-of-classes.html" target="_self"><span>使用任意的类作为实体类</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--label"><span>支持和反馈</span></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/api-docs/index.html" target="_self"><span>API 文档</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="https://github.com/kotlin-orm/ktorm/issues/new" target="_self"><span>问题反馈</span></a></li><li class="doc-sidebar-list__item doc-sidebar-list__item--link"><a href="/zh-cn/sponsor.html" target="_self"><span>打赏作者</span></a></li></ul></div></nav></div></div><div class="doc-content"><div id="lang-switcher-container" class="lang-switcher-container"><span class="lang-switcher" data-reactroot=""><span><img src="/images/cn.png"><span>简体中文</span></span><span class="lang-divider"> | </span><span><img src="/images/us.png"><a href="/en/break-changes-in-ktorm-3.0.html">English</a></span></span></div><div class="dc-page"><div class="dc-card"><div id="doc-search-results" class="doc-search-results"><div id="doc-search-stats"></div><div id="doc-search-hits"></div><div id="doc-search-pagination"></div></div><article id="page-content" class="doc-formatting"><a class="page-link-to-github" target="_blank" href="https://github.com/kotlin-orm/ktorm-docs/edit/master/source/zh-cn/break-changes-in-ktorm-3.0.md"><i class="icon fa fa-github"></i> <span class="text">编辑本页</span></a><h1 id="Ktorm-3-0-不兼容更新"><a href="#Ktorm-3-0-不兼容更新" class="headerlink" title="Ktorm 3.0 不兼容更新"></a>Ktorm 3.0 不兼容更新</h1><p>时隔几个月，我们终于迎来了 Ktorm 的第二次大版本更新（Ktorm 3.0），此次更新包含了多项优化，其中也有一些不兼容的变更，特此说明。</p><blockquote><p>如果这些不兼容的更新对您的项目产生了影响，我们表示十分抱歉，但这是为了确保框架长期迭代必须作出的取舍，请对照更新文档进行简单修改即可，这只会花费您几分钟的时间。</p></blockquote><h2 id="ktorm-global"><a href="#ktorm-global" class="headerlink" title="ktorm-global"></a>ktorm-global</h2><p>Ktorm 2.7 版本废弃了 <code>Database.global</code> 全局变量以及与之相关的一系列 API，从此以后，我们每次操作数据的时候，都需要显式地指定一个 <code>Database</code> 对象，而不是隐式地使用 <code>Database.global</code>。关于上个版本的更多信息，请参考<a href="./about-deprecating-database-global.html">关于废弃 Database.global 对象的说明</a>。</p><p>使用全局变量是糟糕的设计模式， 这样写出来的代码会与全局的状态耦合，不方便扩展，这就是我们要废弃 <code>Database.global</code> 的原因。然而，全局变量也有它不可替代之处，它可以让某些 API 的设计更加简洁，帮助我们写出更简短的代码。比如 <code>Employees.findAll()</code>，在 Ktorm 2.7 以后，我们不得不写成 <code>database.sequenceOf(Employees).toList()</code>，看起来啰嗦好多。</p><p>Ktorm 3.0 已经完全删除了<code>Database.global</code> 相关的 API，但是，为了让大家有更多的选择，我们额外提供了一个 ktorm-global 模块，这个模块重新实现了原来的那套全局变量 API，大家可以按需使用。</p><p>要使用 ktorm-global，首先应该添加一个 Maven 依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.ktorm<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ktorm-global<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;ktorm.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>或者 Gradle：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">"org.ktorm:ktorm-global:$&#123;ktorm.version&#125;"</span></span><br></pre></td></tr></table></figure><p>然后，使用 <code>Database.connectGlobally</code> 函数连接到数据库：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Database.connectGlobally(<span class="string">"jdbc:mysql://localhost:3306/ktorm"</span>, user = <span class="string">"root"</span>, password = <span class="string">"***"</span>)</span><br></pre></td></tr></table></figure><p>这个方法会创建一个 <code>Database</code> 对象并返回，如果你需要的话，可以定义一个变量来保存这个返回值。但是通常来说，你没必要这么做，因为 ktorm-global 会自动记录最近创建的 <code>Database</code> 对象，在需要的时候，使用 <code>Database.global</code> 获取这个对象进行操作。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Database.global.useConnection &#123; conn -&gt; </span><br><span class="line">    <span class="comment">// 使用连接进行操作...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有了全局对象，我们的很多代码都可以变得更简短，比如，直接使用 <code>Table.select</code> 扩展函数就可以创建一个查询：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (row <span class="keyword">in</span> Employees.select()) &#123;</span><br><span class="line">    println(row[Employees.name])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 <code>Table.findList</code> 扩展函数就可以获取表中符合条件的实体对象：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> employees = Employees.findList &#123; it.departmentId eq <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure><p>使用 <code>Table.sumBy</code> 就可以对表中的某个字段求和：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> total = Employees.sumBy &#123; it.salary &#125;</span><br></pre></td></tr></table></figure><p>更多便捷用法请自己探索，也可以参照 <a href="./about-deprecating-database-global.html#修改点">Ktorm 2.7 版本的修改点</a>，那些被废弃的函数，几乎全部都在 ktorm-global 中重新亮相。</p><h2 id="使用-定义列，不再使用属性代理-by"><a href="#使用-定义列，不再使用属性代理-by" class="headerlink" title="使用 = 定义列，不再使用属性代理 by"></a>使用 = 定义列，不再使用属性代理 by</h2><p>在之前，我们定义一个表对象的时候，需要使用 <code>by</code> 关键字，利用属性代理来定义它的列，就像这样：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Ktorm 3.0 之前</span></span><br><span class="line"><span class="keyword">object</span> Departments : Table&lt;<span class="built_in">Nothing</span>&gt;(<span class="string">"t_department"</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> id <span class="keyword">by</span> int(<span class="string">"id"</span>).primaryKey()</span><br><span class="line">    <span class="keyword">val</span> name <span class="keyword">by</span> varchar(<span class="string">"name"</span>)</span><br><span class="line">    <span class="keyword">val</span> location <span class="keyword">by</span> varchar(<span class="string">"location"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在，我们不再需要属性代理，直接使用等号 <code>=</code> 即可：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Ktorm 3.0</span></span><br><span class="line"><span class="keyword">object</span> Departments : Table&lt;<span class="built_in">Nothing</span>&gt;(<span class="string">"t_department"</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> id = int(<span class="string">"id"</span>).primaryKey()</span><br><span class="line">    <span class="keyword">val</span> name = varchar(<span class="string">"name"</span>)</span><br><span class="line">    <span class="keyword">val</span> location = varchar(<span class="string">"location"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用等号 <code>=</code> 更加简单直接，也避免了编译器为属性代理生成的额外字段。但是，这个改动会导致你的项目在升级到新版本之后产生许多编译错误，不用担心，你只需要找到你的所有表对象，把里面的 <code>by</code> 关键字批量替换成等号 <code>=</code> 即可。</p><h2 id="Query-类不再实现-Iterable-接口"><a href="#Query-类不再实现-Iterable-接口" class="headerlink" title="Query 类不再实现 Iterable 接口"></a>Query 类不再实现 Iterable 接口</h2><p>在之前，为了能方便地获取查询结果，我们决定让 <code>Query</code> 类直接实现 <code>Iterable</code> 接口，这样我们就能直接使用 for-each 循环对查询结果进行遍历，也可以使用 <code>map</code>、<code>flatMap</code> 等函数对结果集进行各种各样的处理，比如：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Emp</span></span>(<span class="keyword">val</span> id: <span class="built_in">Int</span>?, <span class="keyword">val</span> name: String?, <span class="keyword">val</span> salary: <span class="built_in">Long</span>?)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> query = database.from(Employees).select()</span><br><span class="line"></span><br><span class="line">query</span><br><span class="line">    .map &#123; row -&gt; Emp(row[Employees.id], row[Employees.name], row[Employees.salary]) &#125;</span><br><span class="line">    .filter &#123; it.salary &gt; <span class="number">1000</span> &#125;</span><br><span class="line">    .sortedBy &#123; it.salary &#125;</span><br><span class="line">    .forEach &#123; println(it.name) &#125;</span><br></pre></td></tr></table></figure><p>但是这也给我们带来了许多问题，因为 <code>Iterable</code> 的许多扩展函数的名称与 <code>Query</code> 的函数类似，甚至还可能存在名称冲突，这会让用户产生许多误解，比如 <a href="https://github.com/kotlin-orm/ktorm/issues/124" target="_blank" rel="noopener">#124</a>、<a href="https://github.com/kotlin-orm/ktorm/issues/125" target="_blank" rel="noopener">#125</a>。</p><p>因此，我们决定在 Ktorm 3.0 中，<code>Query</code> 类不再实现 <code>Iterable</code> 接口，为了确保原来的 DSL 代码不变，我们还提供了与 <code>Iterable</code> 相同的扩展函数。升级之后你会发现，尽管可能会产生一些编译错误，但是你的代码几乎是不用改的，唯一需要的可能是增加一行 <code>import</code> 语句，把原来对 <code>Iterable.map</code> 函数的调用，改成 <code>Query.map</code>：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.ktorm.dsl.*</span><br></pre></td></tr></table></figure><h2 id="支持复合主键"><a href="#支持复合主键" class="headerlink" title="支持复合主键"></a>支持复合主键</h2><p>在 Ktorm 3.0 中，我们还支持为一个表设置复合主键，复合主键由多个字段组成，这些字段共同决定主键的唯一性。使用方法很简单，只需要在定义表对象时，为每个主键字段调用 <code>primaryKey</code> 函数即可：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> Departments : Table&lt;<span class="built_in">Nothing</span>&gt;(<span class="string">"t_department"</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> id = int(<span class="string">"id"</span>).primaryKey()</span><br><span class="line">    <span class="keyword">val</span> name = varchar(<span class="string">"name"</span>).primaryKey()</span><br><span class="line">    <span class="keyword">val</span> location = varchar(<span class="string">"location"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这看起来只是一个简单的功能增强，但这里也存在与之前版本不兼容的地方。<code>BaseTable</code> 类中的 <code>val primaryKey: Column&lt;*&gt;</code> 属性被删除，改为了 <code>val primaryKeys: List&lt;Column&lt;*&gt;&gt;</code>，用于获取组成主键的所有字段。</p><h2 id="其他更新"><a href="#其他更新" class="headerlink" title="其他更新"></a>其他更新</h2><p>除了上述的不兼容变更，Ktorm 3.0 中还有不少来自开源社区热心人的更新，感谢他们的贡献：</p><ul><li>MySQL <code>bulkInsert</code> 函数支持 <code>on duplcate key update</code>，感谢 <a href="https://github.com/hangingman" target="_blank" rel="noopener">@hangingman</a></li><li>PostgreSQL <code>hstore</code> 数据类型及其一系列运算符，感谢 <a href="https://github.com/arustleund" target="_blank" rel="noopener">@arustleund</a></li><li>ktorm-jackson 模块支持简单的 Jackson 注解，如 <code>@JsonProperty</code>、<code>@JsonAlias</code>、<code>@JsonIgnore</code>，感谢 <a href="https://github.com/onXoot" target="_blank" rel="noopener">@onXoot</a></li></ul><div id="support-footer-container"><div class="doc-support-footer" data-reactroot="">对文档内容有疑问？请在侧边栏尝试搜索或者在 GitHub <a href="https://github.com/kotlin-orm/ktorm/issues/new" target="_blank" rel="noopener">提出 issue</a></div></div></article></div></div><div class="doc-footer">&copy; 2022 KTORM.ORG. Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="noopener">Apache 2.0</a><br>Hosted by <a href="https://github.com/kotlin-orm/ktorm" target="_blank" rel="noopener">GitHub</a> <a href="https://github.com/kotlin-orm/ktorm/stargazers" target="_blank" rel="noopener"><img src="https://img.shields.io/github/stars/kotlin-orm/ktorm.svg?style=social" alt="Stars"></a></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script><script src="/script/doc.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script type="text/javascript">docsearch({appId:"0DGANM0MZ3",apiKey:"071ea85fb6b0933d3f3d3925aa434e23",indexName:"ktorm",inputSelector:"#doc-search-input",algoliaOptions:{facetFilters:["lang:zh-cn","tags:doc"]},autocompleteOptions:{hint:!1,appendTo:"body"},debug:!1})</script><script>!function(){$(".kotlin .code .keyword").each(function(){var e=$(this);("where"===e.text()||"set"===e.text())&&e.removeClass("keyword")})}()</script></body></html><!-- rebuild by neat -->