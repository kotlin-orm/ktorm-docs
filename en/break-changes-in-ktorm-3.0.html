<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Ktorm | Break Changes in Ktorm 3.0</title><meta name="keywords" content="Kotlin, ORM, SQL, DSL, sequence"><meta name="description" content=""><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="referrer" content="always"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,600,700" rel="stylesheet"><link href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet"><link href="/vendors/docsearch-css@3.6.2/style.css" rel="stylesheet"><link href="/style/doc.css" rel="stylesheet"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><meta name="generator" content="Hexo 7.3.0"></head><body><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-180275463-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script type="text/javascript">window.__INITIAL_STATE__={page:{title:"Break Changes in Ktorm 3.0",lang:"en",related_path:"zh-cn/break-changes-in-ktorm-3.0.html",path:"en/break-changes-in-ktorm-3.0.html"},data:{"navigation-zh-cn":{home:[{title:"快速上手",link:"zh-cn/quick-start.html",color:"purple",icon:"flash",description:"快速配置 Ktorm 并开始使用"},{title:"SQL DSL",link:"zh-cn/query.html",color:"blue",icon:"code",description:'<a href="/zh-cn/schema-definition.html">定义表结构</a>，使用强类型的灵活的<a href="/zh-cn/query.html">查询 DSL</a>'},{title:"实体序列",link:"zh-cn/entity-sequence.html",color:"green",icon:"line-chart",description:'<a href="/zh-cn/entities-and-column-binding.html">配置列绑定</a>，使用<a href="/zh-cn/entity-sequence.html">序列 API</a> 获取实体对象'},{title:"API 文档",link:"api-docs/index.html",target:"_blank",color:"red",icon:"paperclip",description:"查看 Ktorm 中类与函数的 API 文档"}],main:[{text:"开始",type:"label"},{text:"简介",type:"link",path:"zh-cn/"},{text:"快速上手",type:"link",path:"zh-cn/quick-start.html"},{text:"连接管理",type:"label"},{text:"连接数据库",type:"link",path:"zh-cn/connect-to-databases.html"},{text:"事务管理",type:"link",path:"zh-cn/transaction-management.html"},{text:"Spring 支持",type:"link",path:"zh-cn/spring-support.html"},{text:"SQL DSL",type:"label"},{text:"定义表结构",type:"link",path:"zh-cn/schema-definition.html"},{text:"查询",type:"link",path:"zh-cn/query.html"},{text:"联表",type:"link",path:"zh-cn/joining.html"},{text:"增删改",type:"link",path:"zh-cn/dml.html"},{text:"运算符",type:"link",path:"zh-cn/operators.html"},{text:"方言与原生 SQL",type:"link",path:"zh-cn/dialects-and-native-sql.html"},{text:"实体类 API",type:"label"},{text:"实体类与列绑定",type:"link",path:"zh-cn/entities-and-column-binding.html"},{text:"实体查询",type:"link",path:"zh-cn/entity-finding.html"},{text:"实体序列",type:"link",path:"zh-cn/entity-sequence.html"},{text:"序列聚合",type:"link",path:"zh-cn/sequence-aggregation.html"},{text:"实体增删改",type:"link",path:"zh-cn/entity-dml.html"},{text:"使用任意的类作为实体类",type:"link",path:"zh-cn/define-entities-as-any-kind-of-classes.html"},{text:"支持和反馈",type:"label"},{text:"API 文档",type:"support-link",path:"api-docs/index.html",target:"_blank"},{text:"问题反馈",type:"support-link",path:"https://github.com/kotlin-orm/ktorm/issues/new",target:"_blank"},{text:"打赏作者",type:"support-link",path:"zh-cn/sponsor.html"}]},"navigation-en":{home:[{title:"Quick Start",link:"en/quick-start.html",color:"purple",icon:"flash",description:"Setting up Ktorm and starting up."},{title:"SQL DSL",link:"en/query.html",color:"blue",icon:"code",description:'Use the strong-typed and flexible <a href="/en/query.html">query DSL</a> after <a href="/en/schema-definition.html">defining table schemas</a>.'},{title:"Entity Sequence",link:"en/entity-sequence.html",color:"green",icon:"line-chart",description:'Obtain entities via <a href="/en/entity-sequence.html">sequence APIs</a> after <a href="/en/entities-and-column-binding.html">column bindings</a> configured.'},{title:"API Documents",link:"api-docs/index.html",target:"_blank",color:"red",icon:"paperclip",description:"API documents for Ktorm's classes and functions."}],main:[{text:"GETTING STARTED",type:"label"},{text:"Overview",type:"link",path:"/"},{text:"Quick Start",type:"link",path:"en/quick-start.html"},{text:"CONNECTION MANAGEMENT",type:"label"},{text:"Connect to Databases",type:"link",path:"en/connect-to-databases.html"},{text:"Transaction Management",type:"link",path:"en/transaction-management.html"},{text:"Spring Support",type:"link",path:"en/spring-support.html"},{text:"SQL DSL",type:"label"},{text:"Schema Definition",type:"link",path:"en/schema-definition.html"},{text:"Query",type:"link",path:"en/query.html"},{text:"Joining",type:"link",path:"en/joining.html"},{text:"Data Manipulation",type:"link",path:"en/dml.html"},{text:"Operators",type:"link",path:"en/operators.html"},{text:"Dialects & Native SQL",type:"link",path:"en/dialects-and-native-sql.html"},{text:"ENTITY API",type:"label"},{text:"Entities & Column Binding",type:"link",path:"en/entities-and-column-binding.html"},{text:"Entity Query",type:"link",path:"en/entity-finding.html"},{text:"Entity Sequence",type:"link",path:"en/entity-sequence.html"},{text:"Sequence Aggregation",type:"link",path:"en/sequence-aggregation.html"},{text:"Entity Manipulation",type:"link",path:"en/entity-dml.html"},{text:"Define Entities as Any Class",type:"link",path:"en/define-entities-as-any-kind-of-classes.html"},{text:"SUPPORT & FEEDBACK",type:"label"},{text:"API Documents",type:"support-link",path:"api-docs/index.html",target:"_blank"},{text:"Issue Feedback",type:"support-link",path:"https://github.com/kotlin-orm/ktorm/issues/new",target:"_blank"},{text:"Sponsor the Project",type:"support-link",path:"en/sponsor.html"}]}},config:{timezone:null,root:"/",time_format:"HH:mm:ss",theme:"doc"}},window.localStorage&&"true"===window.localStorage.getItem("navigation_collapsed")&&document.getElementsByTagName("body")[0].classList.add("doc-navigation--is-collapsed")</script><div id="navigation-container"><div class="doc-navigation"><nav class="doc-navbar"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-navbar__sidebar-toggle"></i><span class="doc-navbar__logo"><a href="/"><img src="/images/logo.png" class="doc-navbar__logo__img"><img src="/images/logo-middle.png" class="doc-navbar__logo__img-full"></a></span><i class="dc-icon dc-icon--close dc-icon--interactive doc-sidebar-close doc-navbar__sidebar-close"></i><span class="lang-switcher"><span><img src="/images/us.png"><span>English</span></span><span class="lang-divider"> | </span><span><img src="/images/cn.png"><a href="/zh-cn/break-changes-in-ktorm-3.0.html">简体中文</a></span></span></nav><nav class="doc-sidebar"><div class="doc-sidebar__vertical-menu"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-sidebar-toggle--primary doc-sidebar__vertical-menu__item"></i><i class="dc-icon dc-icon--search dc-icon--interactive doc-sidebar__vertical-menu__item doc-sidebar__vertical-menu__item--primary"></i></div><div class="doc-sidebar-content"><div class="doc-sidebar__search-form"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search documents</span></span><span class="DocSearch-Button-Keys"></span></button></div><ul class="doc-sidebar-list"></ul></div></nav></div></div><div class="doc-content"><div id="lang-switcher-container" class="lang-switcher-container"><span class="lang-switcher"><span><img src="/images/us.png"><span>English</span></span><span class="lang-divider"> | </span><span><img src="/images/cn.png"><a href="/zh-cn/break-changes-in-ktorm-3.0.html">简体中文</a></span></span></div><div class="dc-page"><div class="dc-card"><article id="page-content" class="doc-formatting"><a class="page-link-to-github" target="_blank" href="https://github.com/kotlin-orm/ktorm-docs/edit/master/source/en/break-changes-in-ktorm-3.0.md"><i class="icon fa fa-github"></i> <span class="text">Edit Page</span></a><h1 id="break-changes-in-ktorm-30"><a class="markdownIt-Anchor" href="#break-changes-in-ktorm-30"></a> Break Changes in Ktorm 3.0</h1><p>After a few months, we finally ushered in another major version update of Ktorm (Ktorm 3.0). This update contains many optimizations, and there are also some incompatible changes, which is hereby explained.</p><blockquote><p>If these incompatible updates have an impact on your project, we are very sorry, but this is a trade-off that must be made in order to ensure the long-term iteration of the framework. Please simply modify your code according to this document, which will only cost you a few minutes time.</p></blockquote><h2 id="ktorm-global"><a class="markdownIt-Anchor" href="#ktorm-global"></a> ktorm-global</h2><p>Ktorm 2.7 deprecated the global variable <code>Database.global</code> and a series of APIs based on it, making users explicitly specify the <code>Database</code> instances to use while performing database operations, instead of implicitly use <code>Database.global</code>. For more information about the previous version, please refer to <a href="./about-deprecating-database-global.html">About Deprecating Database.global</a>.</p><p>Using global variables is a bad design pattern. Code written in this way will be coupled with some global states, which is difficult to be tested and extended, and this is why we have to deprecate <code>Database.global</code>. However, there are also some advantages, as we can make some APIs more concise with the help of the global variable. For example, <code>Employees.findAll()</code>, after Ktorm 2.7, we have to write <code>database.sequenceOf(Employees).toList()</code>, which looks a lot more verbose.</p><p>Ktorm 3.0 has completely removed <code>Database.global</code> and its related APIs. But in order to give you more choices, we provide an additional module ktorm-global, which reimplements those deprecated APIs in version 2.7. You can use it as needed.</p><p>To use ktorm-global, you should add a Maven dependency first:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.ktorm<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ktorm-global<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;ktorm.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Or Gradle：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">&quot;org.ktorm:ktorm-global:$&#123;ktorm.version&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>Then connect to the database via function <code>Database.connectGlobally</code>:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Database.connectGlobally(<span class="string">&quot;jdbc:mysql://localhost:3306/ktorm&quot;</span>, user = <span class="string">&quot;root&quot;</span>, password = <span class="string">&quot;***&quot;</span>)</span><br></pre></td></tr></table></figure><p>This function returns a new-created <code>Database</code> object, you can define a variable to save the returned value if needed. But generally, it’s not necessary to do that, because ktorm-global will save the latest created <code>Database</code> instance automatically, then obtain it via <code>Database.global</code> when needed.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Database.global.useConnection &#123; conn -&gt; </span><br><span class="line">    <span class="comment">// Do something with the connection...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>With the help of the global object, our code can be more shorter, for example, create a query by directly using the extension function <code>Table.select</code>:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (row <span class="keyword">in</span> Employees.select()) &#123;</span><br><span class="line">    println(row[Employees.name])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Use <code>Table.findList</code> to obtain entity objects in the table that matches the given condition:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> employees = Employees.findList &#123; it.departmentId eq <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure><p>Use <code>Table.sumBy</code> to sum a column in the table:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> total = Employees.sumBy &#123; it.salary &#125;</span><br></pre></td></tr></table></figure><p>For more convenient usages, please explore by yourself. You can also refer to <a href="./about-deprecating-database-global.html#Changes">Changes in Ktorm 2.7</a>. Almost all those deprecated functions are reimplemented in ktorm-global.</p><h2 id="use-instead-of-property-delegation-to-define-columns"><a class="markdownIt-Anchor" href="#use-instead-of-property-delegation-to-define-columns"></a> Use = Instead of Property Delegation to Define Columns</h2><p>Before Ktorm 3.0, when we created a table object, we needed to use the <code>by</code> keyword and define the columns as property delegates, like this:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Before Ktorm 3.0</span></span><br><span class="line"><span class="keyword">object</span> Departments : Table&lt;<span class="built_in">Nothing</span>&gt;(<span class="string">&quot;t_department&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> id <span class="keyword">by</span> int(<span class="string">&quot;id&quot;</span>).primaryKey()</span><br><span class="line">    <span class="keyword">val</span> name <span class="keyword">by</span> varchar(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> location <span class="keyword">by</span> varchar(<span class="string">&quot;location&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>But now, we no longer need property delegates anymore, just use the equal sign <code>=</code>:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Ktorm 3.0</span></span><br><span class="line"><span class="keyword">object</span> Departments : Table&lt;<span class="built_in">Nothing</span>&gt;(<span class="string">&quot;t_department&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> id = int(<span class="string">&quot;id&quot;</span>).primaryKey()</span><br><span class="line">    <span class="keyword">val</span> name = varchar(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> location = varchar(<span class="string">&quot;location&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Using the equal sign <code>=</code> is more simple and straightforward, and avoids some extra fields generated by the compiler for property delegates. However, this change will cause many compilation errors in your project after upgrading to the new version. Don’t worry, the only thing you need to do is just to find out all table objects in your project, and replace the <code>by</code> keywords with equal signs <code>=</code> in batches.</p><h2 id="query-doesnt-implement-iterable-anymore"><a class="markdownIt-Anchor" href="#query-doesnt-implement-iterable-anymore"></a> Query doesn’t Implement Iterable anymore</h2><p>In the past, in order to easily obtain the query results, we decided to let <code>Query</code> implement the <code>Iterable</code> interface, so that we can iterate the results by a for-each loop, or process them via extension functions like <code>map</code>, <code>flatMap</code>, etc. For example:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Emp</span>(<span class="keyword">val</span> id: <span class="built_in">Int</span>?, <span class="keyword">val</span> name: String?, <span class="keyword">val</span> salary: <span class="built_in">Long</span>?)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> query = database.from(Employees).select()</span><br><span class="line"></span><br><span class="line">query</span><br><span class="line">    .map &#123; row -&gt; Emp(row[Employees.id], row[Employees.name], row[Employees.salary]) &#125;</span><br><span class="line">    .filter &#123; it.salary &gt; <span class="number">1000</span> &#125;</span><br><span class="line">    .sortedBy &#123; it.salary &#125;</span><br><span class="line">    .forEach &#123; println(it.name) &#125;</span><br></pre></td></tr></table></figure><p>But this also brings us a lot of problems, because the names of many extension functions of <code>Iterable</code> are similar to the functions of <code>Query</code>, and there may even be name conflicts, which will cause many misunderstandings for users, such as <a href="https://github.com/kotlin-orm/ktorm/issues/124">#124</a>, <a href="https://github.com/kotlin-orm/ktorm/issues/125">#125</a>.</p><p>Therefore, we decided that in Ktorm 3.0, <code>Query</code> no longer implements the <code>Iterable</code> interface anymore. And to keep our DSL code unchanged, we also provide some extension functions that are equivalent to those of <code>Iterable</code>’s. After the upgrade, you will find that although some compilation errors may occur, your code is almost not needed to change. The only thing you may need is to add a line of <code>import</code> statement to change the original calls to the <code>Iterable.map</code> function to <code>Query.map</code>:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.ktorm.dsl.*</span><br></pre></td></tr></table></figure><h2 id="support-compound-primary-keys"><a class="markdownIt-Anchor" href="#support-compound-primary-keys"></a> Support Compound Primary Keys</h2><p>A compound primary key is composed of multiple columns, which together uniquely identify a table row. In Ktorm 3.0, we also support configuring compound primary keys for tables. The usage is very simple, we just need to call the <code>primaryKey</code> function for each column of the compound keys when creating table objects:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> Departments : Table&lt;<span class="built_in">Nothing</span>&gt;(<span class="string">&quot;t_department&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> id = int(<span class="string">&quot;id&quot;</span>).primaryKey()</span><br><span class="line">    <span class="keyword">val</span> name = varchar(<span class="string">&quot;name&quot;</span>).primaryKey()</span><br><span class="line">    <span class="keyword">val</span> location = varchar(<span class="string">&quot;location&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This is not just a simple enhancement feature, but there is also an incompatibility with previous versions. The <code>val primaryKey: Column&lt;*&gt;</code> property in the <code>BaseTable</code> class has been removed and changed to <code>val primaryKeys: List&lt;Column&lt;*&gt;&gt;</code>, which is used to get all the columns that make up the primary key.</p><h2 id="others"><a class="markdownIt-Anchor" href="#others"></a> Others</h2><p>In addition to the incompatible changes above, Ktorm 3.0 also contains many updates from enthusiasts in the open source community, thanks for their contributions:</p><ul><li>MySQL <code>bulkInsert</code> function supports <code>on duplcate key update</code>. Thank <a href="https://github.com/hangingman">@hangingman</a></li><li>PostgreSQL <code>hstore</code> data type and a series of operators for it. Thank <a href="https://github.com/arustleund">@arustleund</a></li><li>ktorm-jackson supports simple Jackson annotations, like <code>@JsonProperty</code>, <code>@JsonAlias</code>, <code>@JsonIgnore</code>. Thank <a href="https://github.com/onXoot">@onXoot</a></li></ul><div id="support-footer-container"><div class="doc-support-footer">Any questions about the document? Try searching again on the left menu or <a href="https://github.com/kotlin-orm/ktorm/issues/new">raise an issue on GitHub</a></div></div></article></div></div><div class="doc-footer">&copy; 2024 KTORM.ORG. Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0</a><br>Hosted by <a href="https://github.com/kotlin-orm/ktorm">GitHub</a> <a href="https://github.com/kotlin-orm/ktorm/stargazers"><img src="https://img.shields.io/github/stars/kotlin-orm/ktorm.svg?style=social" alt="Stars"></a></div></div><script src="/vendors/jquery@3.2.1/jquery.min.js"></script><script src="/script/doc.js"></script><script>$(".kotlin .code .keyword").each(function(){var e=$(this);"where"!==e.text()&&"set"!==e.text()||e.removeClass("keyword")})</script></body></html>